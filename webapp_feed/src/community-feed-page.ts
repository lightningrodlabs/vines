/** @ui5/webcomponents-fiori */
import "@ui5/webcomponents-fiori/dist/Bar.js";
import "@ui5/webcomponents-fiori/dist/NotificationListItem.js";
import "@ui5/webcomponents-fiori/dist/NotificationAction.js";
import "@ui5/webcomponents-fiori/dist/ShellBar.js";
import "@ui5/webcomponents-fiori/dist/ShellBarItem.js";
/** @ui5/webcomponents */
import "@ui5/webcomponents/dist/Avatar.js"
import "@ui5/webcomponents/dist/AvatarGroup.js"
import "@ui5/webcomponents/dist/Badge.js";
import "@ui5/webcomponents/dist/BusyIndicator.js";
import "@ui5/webcomponents/dist/Button.js";
import "@ui5/webcomponents/dist/CustomListItem.js";
import "@ui5/webcomponents/dist/Card.js";
import "@ui5/webcomponents/dist/CardHeader.js";
import "@ui5/webcomponents/dist/Dialog.js";
import "@ui5/webcomponents/dist/Icon.js";
import "@ui5/webcomponents/dist/Label.js";
import "@ui5/webcomponents/dist/List.js";
import "@ui5/webcomponents/dist/Input.js";
import "@ui5/webcomponents/dist/Menu.js";
import "@ui5/webcomponents/dist/MenuItem.js";
import "@ui5/webcomponents/dist/MultiInput.js";
import "@ui5/webcomponents/dist/Option.js";
import "@ui5/webcomponents/dist/Panel.js";
import "@ui5/webcomponents/dist/Popover.js";
import "@ui5/webcomponents/dist/ProgressIndicator.js";
import "@ui5/webcomponents/dist/features/InputSuggestions.js";
import "@ui5/webcomponents/dist/Select.js";
import "@ui5/webcomponents/dist/StandardListItem.js";
import "@ui5/webcomponents/dist/Switch.js";
import "@ui5/webcomponents/dist/SuggestionItem.js";
import "@ui5/webcomponents/dist/Toast.js";
import "@ui5/webcomponents/dist/Tree.js"
import "@ui5/webcomponents/dist/TreeItem.js";
import "@ui5/webcomponents/dist/TreeItemCustom.js";

import Dialog from "@ui5/webcomponents/dist/Dialog";
import Popover from "@ui5/webcomponents/dist/Popover";
import Input from "@ui5/webcomponents/dist/Input";
import Menu from "@ui5/webcomponents/dist/Menu";
import Button from "@ui5/webcomponents/dist/Button";
import RadioButton from "@ui5/webcomponents/dist/RadioButton";
import ShellBar from "@ui5/webcomponents-fiori/dist/ShellBar";

/** @ui5/webcomponents-icons */
//import "@ui5/webcomponents-icons/dist/allIcons-static.js";
import "@ui5/webcomponents-icons/dist/action-settings.js"
import "@ui5/webcomponents-icons/dist/activate.js"
import "@ui5/webcomponents-icons/dist/add.js"
import "@ui5/webcomponents-icons/dist/add-favorite.js"
import "@ui5/webcomponents-icons/dist/accept.js"
import "@ui5/webcomponents-icons/dist/attachment.js"
import "@ui5/webcomponents-icons/dist/attachment-text-file.js"
import "@ui5/webcomponents-icons/dist/attachment-photo.js"
import "@ui5/webcomponents-icons/dist/attachment-video.js"
import "@ui5/webcomponents-icons/dist/attachment-audio.js"
import "@ui5/webcomponents-icons/dist/attachment-zip-file.js"
import "@ui5/webcomponents-icons/dist/bell.js"
import "@ui5/webcomponents-icons/dist/bookmark.js"
import "@ui5/webcomponents-icons/dist/copy.js"
import "@ui5/webcomponents-icons/dist/chain-link.js"
import "@ui5/webcomponents-icons/dist/close-command-field.js"
import "@ui5/webcomponents-icons/dist/cloud.js"
import "@ui5/webcomponents-icons/dist/comment.js"
import "@ui5/webcomponents-icons/dist/customer.js"
import "@ui5/webcomponents-icons/dist/document.js"
import "@ui5/webcomponents-icons/dist/document-text.js"
import "@ui5/webcomponents-icons/dist/delete.js"
import "@ui5/webcomponents-icons/dist/discussion.js"
import "@ui5/webcomponents-icons/dist/documents.js"
import "@ui5/webcomponents-icons/dist/dropdown.js"
import "@ui5/webcomponents-icons/dist/download.js"
import "@ui5/webcomponents-icons/dist/edit.js"
import "@ui5/webcomponents-icons/dist/email.js"
import "@ui5/webcomponents-icons/dist/error.js"
import "@ui5/webcomponents-icons/dist/feedback.js"
import "@ui5/webcomponents-icons/dist/favorite.js"
import "@ui5/webcomponents-icons/dist/favorite-list.js"
import "@ui5/webcomponents-icons/dist/flag.js"
import "@ui5/webcomponents-icons/dist/forward.js"
import "@ui5/webcomponents-icons/dist/group.js"
import "@ui5/webcomponents-icons/dist/home.js"
import "@ui5/webcomponents-icons/dist/hide.js"
import "@ui5/webcomponents-icons/dist/inbox.js"
import "@ui5/webcomponents-icons/dist/information.js"
import "@ui5/webcomponents-icons/dist/journey-arrive.js"
import "@ui5/webcomponents-icons/dist/journey-depart.js"
import "@ui5/webcomponents-icons/dist/less.js"
import "@ui5/webcomponents-icons/dist/message-success.js"
import "@ui5/webcomponents-icons/dist/marketing-campaign.js"
import "@ui5/webcomponents-icons/dist/navigation-down-arrow.js"
import "@ui5/webcomponents-icons/dist/nav-back.js"
import "@ui5/webcomponents-icons/dist/number-sign.js"
import "@ui5/webcomponents-icons/dist/org-chart.js"
import "@ui5/webcomponents-icons/dist/open-folder.js"
import "@ui5/webcomponents-icons/dist/overflow.js"
import "@ui5/webcomponents-icons/dist/person-placeholder.js"
import "@ui5/webcomponents-icons/dist/process.js"
import "@ui5/webcomponents-icons/dist/product.js"
import "@ui5/webcomponents-icons/dist/pdf-attachment.js"
import "@ui5/webcomponents-icons/dist/save.js"
import "@ui5/webcomponents-icons/dist/sys-add.js"
import "@ui5/webcomponents-icons/dist/show.js"
import "@ui5/webcomponents-icons/dist/synchronize.js"
import "@ui5/webcomponents-icons/dist/user-edit.js"
import "@ui5/webcomponents-icons/dist/upload-to-cloud.js"
import "@ui5/webcomponents-icons/dist/unfavorite.js"
import "@ui5/webcomponents-icons/dist/warning.js"
import "@ui5/webcomponents-icons/dist/workflow-tasks.js"

import '@vaadin/grid/theme/lumo/vaadin-grid.js';
import '@vaadin/grid/theme/lumo/vaadin-grid-selection-column.js';

import "@ddd-qc/path-explorer";
import 'css-doodle';

import {css, html, LitElement, PropertyValues} from "lit";
import {customElement, property, state} from "lit/decorators.js";
import {delay, DnaElement, HappBuildModeType, Dictionary, ActionId, EntryId, DnaId} from "@ddd-qc/lit-happ";

import {
  CommentRequest, composeFeedNotificationTitle,
  globaFilesContext,
  JumpEvent,
  onlineLoadedContext, PostCreatedEvent,
  ProfilePanel, searchFieldStyleTemplate,
  shellBarStyleTemplate, ShowProfileEvent,
  ThreadsDnaPerspective,
  ThreadsDvm,
  ThreadsEntryType,
  ThreadsPerspective, weaveUrlToWal,
  weClientContext,
} from "@vines/elements";

import {WeServicesEx} from "@ddd-qc/we-utils";

import {NetworkInfo, Timestamp} from "@holochain/client";
import {FrameNotification, GroupProfile} from "@lightningrodlabs/we-applet";
import {consume} from "@lit/context";

import {getInitials, Profile as ProfileMat} from "@ddd-qc/profiles-dvm";
import {FilesDvm, prettyFileSize, splitFile, SplitObject} from "@ddd-qc/files";
import {HAPP_BUILD_MODE} from "@ddd-qc/lit-happ/dist/globals";
import {msg} from "@lit/localize";
import {setLocale} from "./localization";
import {toasty} from "@vines/elements/dist/toast";
import {wrapPathInSvg} from "@ddd-qc/we-utils";
import {mdiInformationOutline} from "@mdi/js";
import {parseSearchInput} from "@vines/elements/dist/search";
import {CellIdStr} from "@ddd-qc/cell-proxy/dist/types";
import {AnyBeadMat} from "@vines/elements/dist/viewModels/threads.materialize";

// HACK: For some reason hc-sandbox gives the dna name as cell name instead of the role name...
const FILES_CELL_NAME = HAPP_BUILD_MODE == HappBuildModeType.Debug? 'dFiles' : 'rFiles';

console.log("FILES_CELL_NAME", FILES_CELL_NAME);


/**
 * @element
 */
@customElement("community-feed-page")
export class CommunityFeedPage extends DnaElement<ThreadsDnaPerspective, ThreadsDvm> {

  /** */
  constructor() {
    super(ThreadsDvm.DEFAULT_BASE_ROLE_NAME);
    this.addEventListener('beforeunload', (e) => {
      console.log("<community-feed-page> beforeunload", e);
      // await this._dvm.threadsZvm.commitSearchLogs();
    });
  }


  /** Handle 'jump' event */
  connectedCallback() {
    super.connectedCallback();
    this.addEventListener('jump', this.onJump);
    this.addEventListener('show-profile', this.onShowProfile);
    this.addEventListener('edit-profile', this.onEditProfile);
  }
  disconnectedCallback() {
    super.disconnectedCallback();
    this.removeEventListener('jump', this.onJump);
    this.removeEventListener('edit-profile', this.onEditProfile);
    this.removeEventListener('show-profile', this.onShowProfile);
  }


  /** */
  getDeepestElemAt(x: number, y: number): HTMLElement {
    const elem = this.shadowRoot.elementFromPoint(x, y) as HTMLElement;
    let shadow: HTMLElement = elem;
    let shadower;
    do {
      shadower = undefined;
      if (shadow.shadowRoot) {
        shadower = shadow.shadowRoot.elementFromPoint(x, y) as HTMLElement;
      }
      if (shadower) {
        shadow = shadower;
      }
    } while(shadower);
    return shadow;
  }


  /** */
  onShowProfile(e: CustomEvent<ShowProfileEvent>) {
    console.log("onShowProfile()", e.detail)
    const elem = this.getDeepestElemAt(e.detail.x, e.detail.y);
    //console.log("onShowProfile() elem", elem)
    const popover = this.shadowRoot.getElementById("profilePop") as Popover;
    const sub = this.shadowRoot.getElementById("profilePanel") as ProfilePanel;
    sub.hash = e.detail.agentId;
    sub.requestUpdate();
    popover.showAt(elem);
  }

  /** */
  onEditProfile(e) {
    this.profileDialogElem.show();
  }


  /** -- Fields -- */

  @state() private _canShowFavorites = false;

  @state() private _canViewArchivedSubjects = false;
  @state() private _currentCommentRequest?: CommentRequest;

  @state() private _splitObj?: SplitObject;

  @property() selectedPostAh?: ActionId;

  @property({type: Object})
  networkInfoLogs: Record<CellIdStr, [Timestamp, NetworkInfo][]>;

  //@property() appletId: AppletId;

  @property({type: Object, attribute: false, hasChanged: (_v, _old) => true})
  threadsPerspective!: ThreadsPerspective;

  @consume({ context: globaFilesContext, subscribe: true })
  _filesDvm!: FilesDvm;

  @consume({ context: weClientContext, subscribe: true })
  weServices!: WeServicesEx;

  @consume({ context: onlineLoadedContext, subscribe: true })
  onlineLoaded!: boolean;


  /** -- Getters -- */

  get profileDialogElem(): Dialog {
    return this.shadowRoot!.getElementById("profile-dialog") as Dialog;
  }

  get waitDialogElem(): Dialog {
    return this.shadowRoot!.getElementById("wait-dialog") as Dialog;
  }

  get createPostDialogElem(): Dialog {
    return this.shadowRoot!.getElementById("create-post-dialog") as Dialog;
  }


  /** -- Update -- */

  /** */
  protected async dvmUpdated(newDvm: ThreadsDvm, oldDvm?: ThreadsDvm): Promise<void> {
    console.log("<community-feed-page>.dvmUpdated()");
    if (oldDvm) {
      console.log("\t Unsubscribed to threadsZvm's roleName = ", oldDvm.threadsZvm.cell.name)
      oldDvm.threadsZvm.unsubscribe(this);
    }
    newDvm.threadsZvm.subscribe(this, 'threadsPerspective');
    console.log("\t Subscribed threadsZvm's roleName = ", newDvm.threadsZvm.cell.name)
    //this.selectedPostAh = '';
  }


  // /** */
  // shouldUpdate(changedProperties: PropertyValues<this>): boolean {
  //   const canUpdate = super.shouldUpdate(changedProperties);
  //   if (!canUpdate) {
  //     return false;
  //   }
  //   //console.log("<community-feed-page>.shouldUpdate()", /*canUpdate,*/ changedProperties, JSON.stringify(changedProperties.get("threadsPerspective")));
  //   const threads = this._dvm.threadsZvm.perspective.threadsPerSubject[MAIN_TOPIC_HASH];
  //   //console.log("<community-feed-page>.shouldUpdate() mainThreadContext", threads);
  //   return threads && threads.length > 0;
  // }


  /** After first render only */
  async firstUpdated() {
    console.log("<community-feed-page> firstUpdated()");

    /** Generate test data */
    //await this._dvm.threadsZvm.generateTestData("");

    /** Fiddle with shadow parts CSS */
    const searchField = this.shadowRoot.getElementById('search-field') as Input;
    console.log("search-field", searchField,searchField.shadowRoot);
    if (searchField) {
      searchField.shadowRoot.appendChild(searchFieldStyleTemplate.content.cloneNode(true));
      this.requestUpdate();
    }
    const shellBar = this.shadowRoot.getElementById('topicBar') as ShellBar;
    if (shellBar) {
      shellBar.shadowRoot.appendChild(shellBarStyleTemplate.content.cloneNode(true));
      shellBar.showSearchField = false;
    }

    /** Grab all AppletIds & GroupProfiles */
    if (this.weServices) {
      console.log("<community-feed-page> firstUpdated() calling probeAllAppletIds()", this.weServices);
      const appletIds = await this._dvm.threadsZvm.pullAppletIds();
      console.log("<community-feed-page> firstUpdated() appletIds", appletIds);
      for (const appletId of appletIds) {
        /*const wtf = */ await this.weServices.cacheFullAppletInfo(appletId);
      }
      /** notifyFrame of some new content */
      const allCount = this._dvm.threadsZvm.perspective.unreadThreads.size + this._dvm.threadsZvm.perspective.newThreads.size;
      if (allCount > 0) {
        this.weServices.notifyFrame([{
          title: "New content",
          body: "",
          notification_type: "content",
          icon_src: wrapPathInSvg(mdiInformationOutline),
          urgency: 'medium',
          timestamp: Date.now(),
      }]);
      }
    }
    this.requestUpdate();
    /** */
    this.pingAllOthers();
  }

  private _lastKnownNotificationIndex = 0;


  /** */
  protected async updated(_changedProperties: PropertyValues) {
    // /** ??? */
    // try {
    //   const chatView = this.shadowRoot.getElementById("chat-view") as ChatThreadView;
    //   const view = await chatView.updateComplete;
    //   //console.log("ChatView.parent.updated() ", view, chatView.scrollTop, chatView.scrollHeight, chatView.clientHeight)
    //   if (!view) {
    //     /** Request a new update for scrolling to work */
    //     chatView.requestUpdate();
    //   }
    // } catch(e) {
    //   /** i.e. element not present */
    // }

    /** Grab AssetInfo for all AnyBeads */
    for (const [beadInfo, typed] of this.threadsPerspective.beads.values()) {
      if (beadInfo.beadType != ThreadsEntryType.AnyBead) {
        continue;
      }
      const anyBead = typed as AnyBeadMat;
      const wal = weaveUrlToWal(anyBead.value);
      if (!this.weServices.assetInfoCached(wal)) {
        const maybe = await this.weServices.assetInfo(wal);
        if (maybe) {
          this.requestUpdate();
        }
      }
    }

    /** Create popups from signaled Notifications */
    const weNotifs = [];
    for (const notif of this.perspective.signaledNotifications.slice(this._lastKnownNotificationIndex)) {
      const author = this._dvm.profilesZvm.perspective.getProfile(notif.author) ? this._dvm.profilesZvm.perspective.getProfile(notif.author).nickname : "unknown";
      const canPopup = !notif.author.equals(this.cell.address.agentId) || HAPP_BUILD_MODE == HappBuildModeType.Debug;
      //const date = new Date(notif.timestamp / 1000); // Holochain timestamp is in micro-seconds, Date wants milliseconds
      //const date_str = timeSince(date) + " ago";
      const [notifTitle, notifBody] = composeFeedNotificationTitle(notif, this._dvm, this._filesDvm, this.weServices);
      let message = `"${notifBody}" from @${author}.` ; // | ${date_str}`;
      /** in-app toast */
      if (canPopup) {
        toasty(notifTitle + " " + message);
      }
      /** We Notification */
      if (this.weServices) {
        const myNotif: FrameNotification = {
          title: notifTitle,
          body: message,
          notification_type: notif.event,
          icon_src: wrapPathInSvg(mdiInformationOutline),
          urgency: 'high',
          timestamp: notif.timestamp / 1000,
        }
        weNotifs.push(myNotif);
      }
      this._lastKnownNotificationIndex += 1;
    }
    if (this.weServices && weNotifs.length > 0) {
      this.weServices.notifyFrame(weNotifs);
    }
  }


  /** */
  async handleColorChange(e: any) {
    console.log("handleColorChange: " + e.target.lastValueEmitted)
    const color = e.target.lastValueEmitted;
    const profile = this._dvm.profilesZvm.getMyProfile()!;
    await this.setMyProfile(profile.nickname, profile.fields['avatar'], color)
  }


  /** */
  async setMyProfile(nickname: string, avatar: string, color: string) {
    console.log("updateProfile() called:", nickname)
    const fields: Dictionary<string> = {};
    fields['color'] = color;
    fields['avatar'] = avatar;
    try {
      if (this._dvm.profilesZvm.perspective.getProfile(this._dvm.cell.address.agentId)) {
        await this._dvm.profilesZvm.updateMyProfile({nickname, fields});
      } else {
        await this._dvm.profilesZvm.createMyProfile({nickname, fields});
      }
    } catch (e) {
      console.log("createMyProfile() failed");
      console.log(e);
    }
  }


  /** */
  private async onSaveProfile(profile: ProfileMat) {
    console.log("onSaveProfile()", profile)
    try {
      await this._dvm.profilesZvm.updateMyProfile(profile);
    } catch(e) {
      await this._dvm.profilesZvm.createMyProfile(profile);
    }
    this.profileDialogElem.close(false);
    this.requestUpdate();
  }


  /** */
  async pingActiveOthers() {
    //if (this._currentSpaceEh) {
    console.log("Pinging All Active");
    const currentPeers = this._dvm.allCurrentOthers(this._dvm.profilesZvm.perspective.agents);
    await this._dvm.pingPeers(undefined, currentPeers);
    //}
  }


  /** */
  async pingAllOthers() {
    //if (this._currentSpaceEh) {
    const agents = this._dvm.profilesZvm.perspective.agents.filter((agentKey) => agentKey.equals(this.cell.address.agentId));
    console.log("Pinging All Others", agents);
    await this._dvm.pingPeers(undefined, agents);
    //}
  }


  /** */
  async onCommentingClicked(e: CustomEvent<CommentRequest>) {
    // console.log("onCommentingClicked()", e.detail);
    // const request = e.detail;
    //
    // if (request.viewType == "side") {
    //   const threadHash = request.maybeCommentThread? request.maybeCommentThread : await this.createCommentThread(request);
    //   this._canShowComments = true;
    //   /** Save input field before switching */
    //   if (this._selectedCommentThreadHash) {
    //     const commentView = this.shadowRoot.getElementById("comment-view") as CommentThreadView;
    //     if (commentView) {
    //       this._dvm.perspective.threadInputs[this._selectedCommentThreadHash] = commentView.value;
    //     }
    //   }
    //   this._selectedCommentThreadHash = threadHash;
    //   //this._selectedCommentThreadSubjectName = request.subjectName;
    //   return;
    // }
    //
    // if (!request.maybeCommentThread) {
    //   this._currentCommentRequest = request;
    //   //this._selectedThreadSubjectName = request.subjectName;
    //   return;
    // }
  }


  /** */
  async onJump(e: CustomEvent<JumpEvent>) {
    console.log("<community-feed-page>.onJump()", e.detail);
    /** Close any opened popover */
    const popover = this.shadowRoot.getElementById("notifPopover") as Popover;
    if (popover.isOpen()) {
      popover.close();
    }
    let searchPopElem = this.shadowRoot.getElementById("searchPopover") as Popover;
    if (searchPopElem.isOpen()) {
      searchPopElem.close();
    }
  }


  /** */
  downloadTextFile(filename: string, content: string): void {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.click();
    URL.revokeObjectURL(url);
  }


  /** */
  private addSearch(str: string) {
    const field = this.shadowRoot.getElementById("search-field") as Input;
    let ws = "";
    if (field.value.length > 0 && field.value[field.value.length - 1] != " ") {
      ws = " "
    }
    field.value += ws + str;
    field.focus();
  }


  /** */
  render() {
    console.log("<community-feed-page>.render()", this.onlineLoaded, this.selectedPostAh, /*this._dvm.profilesZvm,*/ this._dvm.threadsZvm.perspective);

    /** This agent's profile info */
    let myProfile = this._dvm.profilesZvm.getMyProfile();
    if (!myProfile) {
      myProfile = {nickname: "unknown", fields: {lang: "en"}} as ProfileMat;
    }
    let lang = myProfile.fields['lang'];
    if (!lang || lang == "") {
      lang = "en";
    }
    setLocale(lang);
    const avatarUrl = myProfile.fields['avatar'];
    const initials = getInitials(myProfile.nickname);

    //const searchValue = this.shadowRoot.getElementById("search-field")? (this.shadowRoot.getElementById("search-field") as Input).value : "";
    //const searchParameters = parseSearchInput(searchValue, this._dvm.profilesZvm.perspective);

    /** Group Info */
    let groupProfile: GroupProfile = {
      name: "CommunityFeed",
      icon_src: "icon.png",
    };

    /* Use weServices, otherise try from dna properties */
    if(this.weServices) {
      const appletInfo = this.weServices.appletInfoCached(new EntryId(this.weServices.appletId));
      console.log("get appletInfo", appletInfo);
      if (appletInfo) {
        console.log("get groupProfile", appletInfo.groupsHashes[0]);
        const weGroup = this.weServices.groupProfileCached(new DnaId(appletInfo.groupsHashes[0]));
        if (weGroup) {
          groupProfile = weGroup;
        }
      }
    } else {
      if (this._dvm.dnaProperties.groupName) {
        groupProfile.name = this._dvm.dnaProperties.groupName;
      }
      if (this._dvm.dnaProperties.groupSvgIcon) {
        // const svg = atob(this._dvm.dnaProperties.groupSvgIcon);
        // console.log("dnaProperties svg", svg);
        // const tagRegex = /^[a-zA-Z][^\s>\/]*(?:\s(?:[^=]+=(?:"[^"]*"|'[^']*'))?)*\s*\/?$/;
        // const isValid = tagRegex.test("svg");
        // if (isValid) {
        //   groupProfile.icon_src = `data:image/svg+xml;base64,${this._dvm.dnaProperties.groupSvgIcon}`;
        // }
        groupProfile.icon_src = `data:image/svg+xml;base64,${this._dvm.dnaProperties.groupSvgIcon}`;
      }
    }

    /** Get network info for this cell */
    //const sId = CellIdStr(this.cell.id);
    //const networkInfos = this.networkInfoLogs && this.networkInfoLogs[sId]? this.networkInfoLogs[sId] : [];
    //const networkInfo = networkInfos.length > 0 ? networkInfos[networkInfos.length - 1][1] : null;


    /** Render all */
    return html`
        <div id="mainDiv" @commenting-clicked=${this.onCommentingClicked}>
          <div id="topBar">
            <sl-tooltip content=${groupProfile.name} style="--show-delay: 500;">
              <ui5-avatar size="S" class="chatAvatar"
                          @click=${() => {
                              //const popover = this.shadowRoot.getElementById("networkPopover") as Popover;
                              //const btn = this.shadowRoot.getElementById("group-div") as HTMLElement;
                              //popover.showAt(btn);
                          }}>
                <img src=${groupProfile.icon_src} style="background: #fff; border: 1px solid #66666669;">
              </ui5-avatar>
            </sl-tooltip>
            <ui5-input id="search-field" placeholder=${msg('Search')} show-clear-icon
                       @input=${(e) => {
                          console.log("<search-field> @input", e.keyCode, e);
                          let searchElem = this.shadowRoot.getElementById("search-field") as Input;
                          let searchPopElem = this.shadowRoot.getElementById("searchPopover") as Popover;
                          if (searchElem.value == "") {
                            searchPopElem.close();
                            this.requestUpdate(); // important
                            return;
                          }
                          searchPopElem.showAt(searchElem, true);
                          searchPopElem.headerText = `${msg("SEARCH FOR")}: ${searchElem.value}`;
                        }}
                                                 @keypress=${(e) => {
                          console.log("<search-field> @keypress", e.keyCode, e);
                          let searchElem = this.shadowRoot.getElementById("search-field") as Input;
                          let searchPopElem = this.shadowRoot.getElementById("searchPopover") as Popover;
                          //let searchResultElem = this.shadowRoot.getElementById("search-result-panel") as Popover;
                          if (searchElem.value != "") {
                            if (e.keyCode === 13) {
                              searchPopElem.close();
                              this.requestUpdate(); // important
                            } else {
                              if (!searchPopElem.isOpen()) {
                                searchPopElem.showAt(searchElem, true);
                              }
                            }
                          } else {
                            // TODO: check if this code branch is actually useful
                            this.requestUpdate(); // important
                          }
                        }}>
            </ui5-input>
            <div style="flex-grow: 1"></div>
            <ui5-button id="favButton" icon="favorite-list" tooltip=${msg("Favorites")}
                        design="${this._canShowFavorites? "Emphasized" : ""}"
                        style="border-radius: 30px;"
                        @click=${() => {this._canShowFavorites = !this._canShowFavorites;}}></ui5-button>
            <ui5-button id="inboxButton" icon="bell" tooltip=${msg("Notifications")}
                        style="border-radius: 30px;"
                        @click=${() => {
                        console.log("inboxButton.click()")
                        const popover = this.shadowRoot.getElementById("notifPopover") as Popover;
                        if (popover.isOpen()) {
                          popover.close();
                          return;
                        }
                        const elem = this.shadowRoot.getElementById("inboxButton");
                        popover.showAt(elem);
                      }}>
            </ui5-button>
              ${this._dvm.threadsZvm.perspective.inbox.size? html`
                  <div id="notifCount">${this._dvm.threadsZvm.perspective.inbox.size}</div>
              `: html``}
              <!-- <ui5-button id="groupBtn" tooltip slot="startButton"
                          style="margin-top:10px;"
                          design="Transparent" icon="navigation-down-arrow"
                          @click=${(e) => {
                            e.preventDefault();
                            //console.log("onSettingsMenu()", e);
                            const menu = this.shadowRoot.getElementById("groupMenu") as Menu;
                            const btn = this.shadowRoot.getElementById("groupBtn") as Button;
                            menu.showAt(btn);
                          }}>
              </ui5-button>
              <ui5-menu id="groupMenu" @item-click=${this.onGroupMenu}>
                        <ui5-menu-item id="createTopic" text=${msg("Create new Topic")} icon="add"></ui5-menu-item>
                        ${this._canViewArchivedSubjects
                            ? html`<ui5-menu-item id="viewArchived" text=${msg("Hide Archived Topics")} icon="hide"></ui5-menu-item>`
                            : html`<ui5-menu-item id="viewArchived" text=${msg("View Archived Topics")} icon="show"></ui5-menu-item>`}
                        <ui5-menu-item id="markAllRead" text=${msg("Mark all as read")}></ui5-menu-item>
              </ui5-menu> -->
              <ui5-button id="settingsBtn"
                          icon="action-settings" tooltip=${msg("Settings")}
                          style="border-radius: 30px;"
                          @click=${(e) => {
                            //console.log("onSettingsMenu()", e);
                            const settingsMenu = this.shadowRoot.getElementById("settingsMenu") as Menu;
                            const settingsBtn = this.shadowRoot.getElementById("settingsBtn") as Button;
                            settingsMenu.showAt(settingsBtn);
                          }}>
              </ui5-button>
                <ui5-menu id="settingsMenu" header-text=${msg("Settings")} 
                          @item-click=${(e) => this.onSettingsMenu(e)}>
                    <ui5-menu-item id="editProfileItem" text=${msg("Edit Profile")} icon="user-edit"></ui5-menu-item>
                    <ui5-menu-item id="exportItem" text="Export Local" icon="save" starts-section></ui5-menu-item>
                    <ui5-menu-item id="exportAllItem" text=${msg("Export All")} icon="save" starts-section></ui5-menu-item>
                    <ui5-menu-item id="importCommitItem" text=${msg("Import & commit")} icon="open-folder" ></ui5-menu-item>
                    <ui5-menu-item id="importOnlyItem" text=${msg("Import only")} icon="open-folder" ></ui5-menu-item>
                    <ui5-menu-item id="bugItem" text=${msg("Report Bug")} icon="marketing-campaign" starts-section></ui5-menu-item>
                    <ui5-menu-item id="dumpItem" text=${"Dump app logs"}></ui5-menu-item>
                    <ui5-menu-item id="dumpNetworkItem" text="Dump Network logs"></ui5-menu-item>
                    <ui5-menu-item id="uploadFileItem" text=${msg("Import File")} icon="upload-to-cloud"></ui5-menu-item>                    
                </ui5-menu>
              <ui5-avatar size="S" class="chatAvatar" initials=${initials} color-scheme="Accent2"
                          @click=${(e) => {
                              e.stopPropagation();
                              this.dispatchEvent(new CustomEvent<ShowProfileEvent>('show-profile', {detail: {agentId: this.cell.address.agentId, x: e.clientX, y: e.clientY}, bubbles: true, composed: true}));}}>
                  ${avatarUrl? html`<img src=${avatarUrl}>` : html``}
              </ui5-avatar>              
          </div>
          
          <!-- Main area -->  
          <div style="display:flex; flex-direction:row; flex-grow: 1;">
            <div id="left" style="flex-grow:1"></div>
            <div id="center" style="padding-top: 80px;">
                <post-thread-view id="feed" .beadAh=${this.selectedPostAh} .favorites=${this._canShowFavorites}>
                ${this._splitObj? html`
                  <div id="uploadCard">
                    <div style="padding:5px;">Uploading ${this._filesDvm.perspective.uploadStates[this._splitObj.dataHash].file.name}</div>
                    <ui5-progress-indicator style="width:100%;"></ui5-progress-indicator>
                  </div>
                ` : html`
                    <div class="reply-info" style="display: ${this._currentCommentRequest? "block" : "none"}">
                      Thread about "${this._currentCommentRequest? this._currentCommentRequest.subjectName : ''}"
                      <ui5-button icon="delete" design="Transparent"
                                  style="border:none; padding:0px"
                                  @click=${(e) => {this._currentCommentRequest = undefined;}}></ui5-button>
                    </div>`
                }
            </div>
            <div id="right" style="flex-grow:1"></div>
        </div>
        
          <ui5-popover id="searchPopover" header-text="SEARCH FOR: " hide-arrow placement-type="Bottom" horizontal-align="Stretch">
              <div class="popover-content">
                  <ui5-list mode="None" separators="None">
                      <ui5-li-groupheader class="search-group-header">${msg("Search Options")}</ui5-li-groupheader>
                      <!-- <ui5-li @click=${(e) => this.addSearch("in:")}><b>in:</b> <i>thread</i></ui5-li> -->
                      <ui5-li @click=${(e) => this.addSearch("from:")}><b>from:</b> <i>user</i></ui5-li>
                      <ui5-li @click=${(e) => this.addSearch("mentions:")}><b>mentions:</b> <i>user</i></ui5-li>
                      <ui5-li @click=${(e) => this.addSearch("before:")}><b>before:</b> <i>date</i></ui5-li>
                      <ui5-li @click=${(e) => this.addSearch("after:")}><b>after:</b> <i>date</i></ui5-li>
                  </ui5-list>
              </div>
          </ui5-popover>
  
          <ui5-popover id="notifPopover" header-text="Inbox" placement-type="Bottom" horizontal-align="Right" hide-arrow style="max-width: 500px">
              <notification-list feed></notification-list>
          </ui5-popover>
            
        </div>
        <!-- FAB -->
        <ui5-button id="create-fab" icon="add" design="Emphasized" tooltip=${msg("Create Post")} @click=${(e) => this.createPostDialogElem.show()}></ui5-button>
        <!-- DIALOGS -->
        <ui5-dialog id="wait-dialog">
            <ui5-busy-indicator delay="0" size="Large" active style="padding-top:20px; width:100%;"></ui5-busy-indicator>
        </ui5-dialog>
        <ui5-dialog id="create-post-dialog">
            <create-post-panel
                    @created=${async (e: CustomEvent<PostCreatedEvent>) => {
                      console.log("@created", e.detail); 
                      this.createPostDialogElem.close(false);
                      if (e.detail.createdMainThread) {
                        // FIXME: Find a way to refresh feed
                        window.location.reload();
                        // const feed = this.shadowRoot.getElementById("feed") as LitElement;
                        // await this._dvm.threadsZvm.probeSubjectThreads(MAIN_TOPIC_HASH);
                        // feed.requestUpdate();
                      }
                    }}
                    @cancel=${() => this.createPostDialogElem.close(false)}
            ></create-post-panel>
        </ui5-dialog>
        <!-- Profile  -->
        <ui5-popover id="profilePop" hide-arrow allow-target-overlap placement-type="Right" style="min-width: 0px;">
            <profile-panel id="profilePanel" @edit-profile=${(e) => (this.shadowRoot.getElementById("profilePop") as Popover).close()}></profile-panel>
        </ui5-popover>
        <ui5-dialog id="profile-dialog" header-text=${msg("Edit Profile")}>
            <vines-edit-profile
                    allowCancel
                    .profile=${myProfile}
                    .saveProfileLabel= ${msg('Edit Profile')}
                    @cancel-edit-profile=${() => this.profileDialogElem.close(false)}
                    @lang-selected=${(e: CustomEvent) => setLocale(e.detail)}
                    @save-profile=${(e: CustomEvent) => this.onSaveProfile(e.detail)}
            ></vines-edit-profile>
        </ui5-dialog>
    `;
  }


  /** */
  private importDvm(canPublish: boolean) {
    console.log("importDvm()");
    //console.log("<store-dialog> localOnly", localOnly, this._localOnly);
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = ".json";
    input.onchange = async (e:any) => {
      console.log("onImport() target download file", e);
      const file = e.target.files[0];
      if (!file) {
        console.error("No file selected");
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        const contents = reader.result as string;
        //console.log(contents);
        this._dvm.importPerspective(contents, canPublish);
      };
      // Read the file as text
      reader.readAsText(file);
    }
    input.click();
  }


  /** */
  private openFile() {
    console.log("<community-feed-page>.openFile()");
    var input = document.createElement('input');
    input.type = 'file';
    input.onchange = async (e:any) => {
      console.log("<community-feed-page> target download file", e);
      const file = e.target.files[0];
      if (file.size > this._filesDvm.dnaProperties.maxParcelSize) {
        toasty(`Error: File is too big ${prettyFileSize(file.size)}. Maximum file size: ${prettyFileSize(this._filesDvm.dnaProperties.maxParcelSize)}`);
        return;
      }
      const splitObj = await splitFile(file, this._filesDvm.dnaProperties.maxChunkSize);
      const maybeSplitObj = await this._filesDvm.startPublishFile(file, []/*this._selectedTags*/, this._dvm.profilesZvm.perspective.agents, (_manifestEh) => {
        toasty(msg("File successfully shared") +": " + splitObj.dataHash);
        this.requestUpdate();
      });
      if (!maybeSplitObj) {
        toasty(msg("Error: File already shared to group or stored locally"));
      }
    }
    input.click();
  }


  /** */
  async onGroupMenu(e): Promise<void> {
    console.log("onGroupMenu item-click", e)
    switch (e.detail.item.id) {
      case "viewArchived": this.onShowArchiveTopicsBtn(e); break;
      case "markAllRead": this.onCommitBtn(e); break;
    }
  }



  /** */
  async onSettingsMenu(e): Promise<void> {
    console.log("item-click", e);
    this.waitDialogElem.show();
    let content = "";
    switch (e.detail.item.id) {
      case "uploadFileItem": this.openFile(); break;
      case "editProfileItem": this.profileDialogElem.show(); break;
      case "exportAllItem":
        if (content == "") content = await this._dvm.exportAllPerspective();
      case "exportItem":
        const files_json = await this._filesDvm.exportPerspective();
        this.downloadTextFile("dump_feed_files.json", files_json);
        if (content == "") content = this._dvm.exportPerspective();
        this.downloadTextFile("dump_feed.json", content);
        toasty(`Exported data to json in Downloads folder`);
        break;
      case "importCommitItem": this.importDvm(true); break;
      case "importOnlyItem": this.importDvm(false); break;
      case "bugItem": window.open(`https://github.com/lightningrodlabs/threads/issues/new`, '_blank'); break;
      case "dumpItem": this._dvm.dumpCallLogs(); this._dvm.dumpSignalLogs(); this._filesDvm.dumpSignalLogs(); break;
      case "dumpNetworkItem": this.dispatchEvent(new CustomEvent('dumpNetworkLogs', {detail: null, bubbles: true, composed: true})); break;
    }
    this.waitDialogElem.close();
  }


  /** */
  async refresh(_e?: any) {
    await this._dvm.threadsZvm.zomeProxy.probeInbox();
    console.log("Inbox:", this._dvm.threadsZvm.perspective.inbox.size);
    // const mentionsList = this.shadowRoot.getElementById("mentionsList") as MentionsList;
    // mentionsList.requestUpdate();
  }


  /** */
  async onCommitBtn(_e?: any) {
    toasty("All marked 'read' & cleared Inbox");
    await this._dvm.threadsZvm.commitAllProbeLogs();
    await this._dvm.threadsZvm.flushInbox();
    //const semTopic = this.shadowRoot.getElementById("topicusView") as SemanticTopicsView;
    //semTopic.requestUpdate();
  }


  /** */
  onShowArchiveTopicsBtn(_e?: any) {
    this._canViewArchivedSubjects = !this._canViewArchivedSubjects;
  }



  /** */
  static get styles() {
    return [
      css`
        :host {
          /*background: #FBFCFD;*/
          background: white;
          display: block;
          height: 100vh;
          width: 100vw;
        }

        #create-fab {
          position: fixed;
          bottom: 30px;
          right: 30px;
          border-radius: 50%;
          box-shadow: rgba(0, 0, 0, 0.3) 0px 19px 38px, rgba(0, 0, 0, 0.22) 0px 15px 12px;
          width: 4.5em;
          height: 4.5em;
        }
        
        abbr {
          text-decoration: none;
        }

        #profile-div:hover {
          background: rgba(214, 226, 245, 0.8);
          outline: 1px solid darkblue;
        }

        #create-post-dialog::part(content) {
          padding: 0px;
        }
        .reply-info {
          background: #b4c4be;
          margin: 0px 10px -9px 10px;
          padding: 5px;
          border: 1px solid black;
        }

        .ui5-select-label-root {
          font-size: larger;
          font-weight: bold;
        }

        #mainDiv {
          display: flex;
          flex-direction: column;
          height: inherit;
          overflow: auto;
        }

        #groupLabel {
          /*display: flex;*/
          /*align-items: center;*/
        }
        
        #profilePop::part(content) {
          padding: 0px;
        }
        
        #profile-row {
          display: flex;
          flex-direction: row;
          padding-right: 5px;
          background: #e8e8e8;
          /*background: white;*/
          /*box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;*/
        }


        .shellbtn {
          color: #464646;
        }
        .shellbtn:hover {
          background: #e6e6e6;
        }

        #topBar {
          display: flex;
          flex-direction: row;
          gap: 5px;
          align-items: center;
          background: white;
          padding-left: 2px;
          border-radius:5px;
          /*box-shadow: rgba(30, 30, 30, 0.17) 2px 10px 10px;*/
          box-shadow: rgba(0, 0, 0, 0.2) 0px 8px 30px 0px;
          position: fixed;
          width: 100%;
          z-index: 10;
        }


        .chatAvatar {
          margin-top: 5px;
          margin-left: 5px;
          margin-bottom: 5px;
          margin-right: 5px;
          min-width: 48px;
          cursor:pointer;
        }

        #threadTitle {
          font-size: 18px;
          font-weight: bold;
        }

        #uploadCard {
          margin: auto;
          /*margin-left:10px;*/
          min-width: 350px;
          width: 90%;
          padding: 5px;
          display: flex;
          flex-direction: column;
          border: 1px solid black;
          background: beige;
        }

        #group-div {
          display: flex;
          flex-direction: row;
          cursor:pointer;
          background: none;
          padding-right: 7px;
        }

        #dna-select {
          width:auto;
          border:none;
          margin:0px 1px 0px 1px;
          background: none;
          padding-left: 5px;
          padding-right: 7px;
          margin-top:15px;
          margin-bottom:15px;
        }
        
        .popover-content {
          display: flex;
          flex-direction: column;
          justify-content: center;
          margin-top: -20px;
          margin-left: -12px;
        }

        .flex-column {
          display: flex;
          flex-direction: column;
        }

        .popover-footer {
          display: flex;
          justify-content: flex-end;
          width: 100%;
          align-items: center;
          padding: 0.5rem 0;
        }

        .search-group-header {
          text-transform: uppercase;
          padding-top: 0px;
        }
        
        #notifCount {
          border-radius: 50%;
          background: red;
          position: absolute;
          top: 10px;
          right: 104px;
          padding: 4px;
          font-size: 0.6em;
          color: white;
          font-weight: bold;
          text-align: center;
          min-width: 1em;
        }
        
      `,

    ];
  }
}
